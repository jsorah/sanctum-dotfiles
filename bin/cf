#!/bin/sh
# Count entries in a given set of directories
self=cf

# Iterate over remaining non-option arguments (directories); default to current
# directory if none given
for dir in "${@:-.}" ; do

    # Warn if a non-directory was given, flag errors, but continue
    if ! [ -d "$dir" ] ; then
        printf >&2 '%s: %s: not a directory\n' \
            "$self" "$dir"
        ex=1
        continue
    fi

    # Make an escaped form of the directory to handle cases where the directory
    # name actually has find(1) pattern metacharacters in it
    dirx=$(printf %s "$dir" | sed 's/\([*?\[\]]\)/\\\1/g')

    # Count the files
    count=$(
        find "$dir" ! -path "$dirx" -prune -exec printf %.sx {} + |
        wc -c
    )

    # Print the count and the dirname
    printf '%u\t%s\n' "$count" "$dir"
done

# Exit non-zero if a non-directory was given as an argument
exit "${ex:-0}"
