#!/bin/sh

# Set up exceptions file if it exists
ef=$HOME/.plenv/non-cpanm-modules
[ -e "$ef" ] || ef=/dev/null

# Check that exceptions file is sorted
if ! sort -c -- "$ef" ; then
    printf '%s not sorted\n' "$ef" >&2
    exit 1
fi

# Get the list of modules
plenv list-modules |

# Exclude any modules in ~.plenv/non-cpanm-modules if it exists
comm -23 -- - "$ef" |

# Read that list of modules to upgrade and upgrade them one by one
while read -r module ; do
    cpanm --notest --quiet -- "$module"
done
