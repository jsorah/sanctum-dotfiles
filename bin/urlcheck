#!/usr/bin/env bash
self=urlcheck
tm=${URLCHECK_TIMEOUT:-8}
declare -i ex
head=$(mktemp) || exit
body=$(mktemp) || exit
cleanup() {
    rm -f -- "$head" "$body"
}
trap cleanup EXIT
while read -r url ; do
    [[ $url == 'http'* ]] || continue
    if ! curl -fHLsS -D "$head" -m "$tm" -o "$body" "$url" ; then
        printf '%s: %s raises error\n' \
            "$self" "$url" >&2
        continue
    fi
    while IFS=': ' read -r header value ; do
        [[ $header == 'Location' ]] || continue
        printf '%s: %s redirects to %s\n' \
            "$self" "$url" "$value" >&2
        break
    done < "$head"
    [[ $url == 'http:'* ]] || continue
    securl=${url/http:/https:}
    if curl -fLsS -m "$tm" -o /dev/null -- "$securl" 2>/dev/null ; then
        printf '%s: %s has a working secure version at %s\n' \
            "$self" "$url" "$securl" >&2
        ((ex++))
    fi
done
exit "$((ex > 0))"
