#!/usr/bin/env bash
# Run ed(1) over multiple files, duplicating stdin.

# Give up completely if no BASH_VERSINFO (<2.0)
[ -n "$BASH_VERSINFO" ] || exit

# Parse options out, give help if necessary
declare -a opts
for arg ; do
    case $arg in
        --)
            shift
            break
            ;;
        -*)
            shift
            opts[${#opts[@]}]=$arg
            ;;
    esac
done

# Need at least one file after options are parsed out
if ! (($#)) ; then
    printf >&2 'edda: Need at least one file\n'
    exit 2
fi

# Duplicate stdin into a file, which we'll remove on exit
stdin=$(mktemp -t "$self".XXXXXX) || exit
cleanup() {
    rm -f -- "$stdin"
}
trap cleanup EXIT
cat > "$stdin"

# Run ed(1) over each file with the options and stdin given
for file ; do
    ed "${opts[@]}" -- "$file" < "$stdin"
done
